name: r-sec

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-stack:
    runs-on: ubuntu-latest
    outputs:
      has_description: ${{ steps.scan.outputs.has_description }}
      has_dockerfile: ${{ steps.scan.outputs.has_dockerfile }}
      has_non_r_code: ${{ steps.scan.outputs.has_non_r_code }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - id: scan
        run: |
          [ -f DESCRIPTION ] && echo "has_description=true" >> "$GITHUB_OUTPUT" || echo "has_description=false" >> "$GITHUB_OUTPUT"
          ls Dockerfile* >/dev/null 2>&1 && echo "has_dockerfile=true" >> "$GITHUB_OUTPUT" || echo "has_dockerfile=false" >> "$GITHUB_OUTPUT"
          if find . -type f \( -name '*.py' -o -name '*.js' -o -name '*.ts' -o -name '*.go' -o -name '*.java' \) | grep -q .; then
            echo "has_non_r_code=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_non_r_code=false" >> "$GITHUB_OUTPUT"
          fi

  r-tests:
    needs: detect-stack
    if: needs.detect-stack.outputs.has_description == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - uses: r-lib/actions/setup-r@6f6e5bc62fba3a704f74e7ad7ef7676c5c6a2590  # v2
        with:
          use-public-rspm: true
      - uses: r-lib/actions/setup-r-dependencies@6f6e5bc62fba3a704f74e7ad7ef7676c5c6a2590  # v2
      - name: Run testthat
        run: Rscript -e 'testthat::test_dir("tests/testthat")'

  lintr:
    needs: detect-stack
    if: needs.detect-stack.outputs.has_description == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - uses: r-lib/actions/setup-r@6f6e5bc62fba3a704f74e7ad7ef7676c5c6a2590  # v2
      - uses: r-lib/actions/setup-r-dependencies@6f6e5bc62fba3a704f74e7ad7ef7676c5c6a2590  # v2
        with:
          extra-packages: any::lintr
      - name: Run lintr
        run: |
          Rscript -e '
            paths <- unique(c(
              list.files(".", pattern="\\.R$", recursive=FALSE, full.names=TRUE),
              list.files("R", pattern="\\.R$", recursive=TRUE, full.names=TRUE),
              list.files("code", pattern="\\.R$", recursive=TRUE, full.names=TRUE),
              list.files("tests", pattern="\\.R$", recursive=TRUE, full.names=TRUE)
            ))
            if (length(paths) == 0) { message("No R files found"); quit(status = 0) }
            lint_out <- do.call(c, lapply(paths, lintr::lint))
            if (length(lint_out) > 0) print(lint_out)
          '

  secrets:
    needs: detect-stack
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
      - uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v5.4.0
        with:
          python-version: "3.11"
      - name: Install detect-secrets
        run: python -m pip install --upgrade detect-secrets
      - name: Run detect-secrets on changed files
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          else
            git diff --name-only ${{ github.event.before }}...${{ github.sha }} > changed_files.txt
          fi
          if [[ -s changed_files.txt ]]; then
            detect-secrets-hook --baseline .secrets.baseline $(cat changed_files.txt)
          else
            echo "No changed files to scan"
          fi
      - name: Download gitleaks
        run: |
          curl -sSL -o gitleaks.tar.gz \
            https://github.com/gitleaks/gitleaks/releases/download/v8.24.2/gitleaks_8.24.2_linux_x64.tar.gz
          # Verify binary integrity before execution; checksum from gitleaks_8.24.2_checksums.txt
          echo "fa0500f6b7e41d28791ebc680f5dd9899cd42b58629218a5f041efa899151a8e  gitleaks.tar.gz" | sha256sum -c
          tar -xzf gitleaks.tar.gz
      - name: Run gitleaks full-history
        run: ./gitleaks git --redact --no-banner --config .gitleaks.toml

  yamllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v5.4.0
        with:
          python-version: "3.11"
      - run: python -m pip install --upgrade yamllint
      - run: yamllint .

  docker-security:
    needs: detect-stack
    if: needs.detect-stack.outputs.has_dockerfile == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - name: Hadolint
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf  # v3.1.0
        with:
          dockerfile: Dockerfile
      - name: Build image
        run: docker build -t local/r-sec:latest -f Dockerfile .
      - name: Trivy image scan
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284  # 0.34.0
        with:
          image-ref: local/r-sec:latest
          format: table
          exit-code: '1'
          severity: CRITICAL,HIGH

  codeql:
    needs: detect-stack
    if: needs.detect-stack.outputs.has_non_r_code == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: ["javascript-typescript", "python"]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - uses: github/codeql-action/init@f5c2471be782132e47a6e6f9c725e56730d6e9a3  # v3
        with:
          languages: ${{ matrix.language }}
      - uses: github/codeql-action/analyze@f5c2471be782132e47a6e6f9c725e56730d6e9a3  # v3
