# API and Script Reference

This page is generated by `scripts/generate_reference_docs.R`.

Generated on: `2026-02-20 13:03:19 EST`

## Included Sources

- `R/config.R`
- `R/utils.R`
- `code/URL_DIGEST.R`
- `code/find_excel_path.R`
- `code/download_files.R`
- `main.R`
- `install_dependencies.R`

## Function Inventory

### `R/config.R`

#### `get_env()`

Read environment variable with optional required/default behavior.

```r
get_env <- function(name, required = TRUE, default = NULL) {
```

Parameters:

- `name`: Environment variable key.
- `required`: Whether missing values should throw an error.
- `default`: Optional fallback value for empty/missing values.

Returns: Character scalar value.

#### `load_config()`

Load Downloader Configuration

```r
load_config <- function(config_path = NULL, config_env = NULL) {
```

Parameters:

- `config_path`: Optional path to a YAML configuration file.
- `config_env`: Optional environment containing compatibility variables.

Returns: A validated list of configuration settings.

#### `validate_config()`

Validate Downloader Configuration

```r
validate_config <- function(config) {
```

Parameters:

- `config`: Configuration list to validate.

Returns: A validated and corrected configuration list.

#### `create_config_env()`

Create Compatibility Configuration Environment

```r
create_config_env <- function(config) {
```

Parameters:

- `config`: Configuration list.

Returns: An environment containing configuration variables.

### `R/utils.R`

#### `safe_read_html()`

Read HTML with Retry and Backoff

```r
safe_read_html <- function(url,
```

Parameters:

- `url`: A character string containing the URL to fetch.
- `max_retries`: Integer specifying the maximum number of retry attempts (default: 5).
- `initial_delay`: Initial delay in seconds between retries (default: 1).
- `max_delay`: Maximum delay in seconds between retries (default: 30).
- `user_agent`: Custom user agent string for the request (default: "R-digest-downloader").

Returns: An `xml_document` on success, or `NULL` after all retries fail.

#### `ensure_dir()`

Ensure Directory Exists

```r
ensure_dir <- function(path, verbose = FALSE) {
```

Parameters:

- `path`: A character string representing the directory path.
- `verbose`: Logical indicating whether to print messages (default: FALSE).

Returns: The specified path, returned invisibly for chaining.

#### `calculate_file_hash()`

Calculate File Hash

```r
calculate_file_hash <- function(file_path, algo = "md5") {
```

Parameters:

- `file_path`: Path to the file to hash.
- `algo`: Hash algorithm to use (default: "md5").

Returns: A character string with the hash value or NA on failure.

#### `validate_excel_payload()`

Validate Excel Payload Magic Bytes

```r
validate_excel_payload <- function(file_path, expected_extension = NULL) {
```

Parameters:

- `file_path`: Path to the downloaded file payload.
- `expected_extension`: Optional extension hint (`xls`/`xlsx`), with or

Returns: A named list containing validation status and detected signature

#### `register_file_hash()`

Add Entry to Hash Registry

```r
register_file_hash <- function(file_path, hash, download_date = Sys.Date(),
```

Parameters:

- `file_path`: Path to the file being registered.
- `hash`: Hash value of the file.
- `download_date`: Date of download (defaults to current date).
- `registry_path`: Path to the registry CSV file.

Returns: TRUE if successful, FALSE otherwise.

#### `check_hash_registry()`

Check if File Exists in Hash Registry

```r
check_hash_registry <- function(file_path, hash = NULL,
```

Parameters:

- `file_path`: Path to the file to check.
- `hash`: Optional hash value to compare against registered hash.
- `registry_path`: Path to the registry CSV file.

Returns: A list with status and match information or FALSE if file not found.

### `code/URL_DIGEST.R`

#### `extract_digest_tables()`

Extract Digest Table Metadata

```r
extract_digest_tables <- function(year_short) {
```

Parameters:

- `year_short`: A numeric value representing the two-digit digest year.

Returns: A tibble with table metadata or empty tibble on failure.

#### `enhance_with_page_titles()`

Enrich Table Metadata with Page Titles

```r
enhance_with_page_titles <- function(tables_df, batch_size = 10) {
```

Parameters:

- `tables_df`: Tibble with table metadata.
- `batch_size`: Number of pages to process in each batch.

Returns: Enhanced tibble with page titles.

### `code/find_excel_path.R`

#### `get_excel_link_from_page()`

Extract Excel Link and Normalized Title

```r
get_excel_link_from_page <- function(row) {
```

Parameters:

- `row`: Data for a single table.

Returns: A tibble row with extracted data.

#### `construct_direct_excel_url()`

Construct Direct Excel URL Without HTML Scraping

```r
construct_direct_excel_url <- function(row) {
```

Parameters:

- `row`: A row from the tables dataframe containing year and table_number

Returns: A string with the constructed Excel URL or NA if not possible

### `code/download_files.R`

#### `register_file_hash()`

Record a hash entry in the in-memory registry.

```r
register_file_hash <- function(file_path, hash, download_date = Sys.Date(),
```

Parameters:

- `file_path`: Destination file path.
- `hash`: Hash digest value for the file.
- `download_date`: Download date for the registry row.
- `registry_path`: Unused compatibility parameter.

Returns: Logical `TRUE` when entry is recorded, otherwise `FALSE`.

#### `check_hash_registry()`

Look up an existing hash registry entry for a file path.

```r
check_hash_registry <- function(file_path, hash = NULL, registry_path = NULL) {
```

Parameters:

- `file_path`: Destination file path to search.
- `hash`: Optional hash for equality comparison.
- `registry_path`: Unused compatibility parameter.

Returns: Named list containing existence, hash match, and latest metadata.

#### `apply_throttling()`

Enforce adaptive request delay between downloads.

```r
apply_throttling <- function() {
```

Returns: `NULL`; updates global throttle state by side effect.

#### `adjust_throttling()`

Adjust adaptive throttling state based on prior download outcome.

```r
adjust_throttling <- function(success) {
```

Parameters:

- `success`: Logical indicating success of the previous attempt.

Returns: `NULL`; updates global throttle state by side effect.

#### `download_excel_file()`

Download one Excel file with retry, validation, and hash registration.

```r
download_excel_file <- function(url, dest_path, min_size = 5000, max_retries = 5, overwrite = FALSE, verify_extension = TRUE) {
```

Parameters:

- `url`: Source file URL.
- `dest_path`: Destination file path.
- `min_size`: Minimum byte size required for a valid payload.
- `max_retries`: Maximum download retry attempts.
- `overwrite`: Logical indicating whether to replace existing files.
- `verify_extension`: Logical indicating whether URL extension is validated.

Returns: List containing status, hash, destination path, and optional errors.

#### `extract_xml_properties()`

Extract metadata fields from an `.xlsx` file's core properties.

```r
extract_xml_properties <- function(file_path) {
```

Parameters:

- `file_path`: Local file path to an Excel artifact.

Returns: Named list of metadata fields with `NA` when unavailable.

#### `download_excel_file_with_reporting()`

Download one table artifact and return a normalized log row.

```r
download_excel_file_with_reporting <- function(row_index, row, overwrite = FALSE, min_file_size = 5000) {
```

Parameters:

- `row_index`: Row index from `excel_links_df`.
- `row`: Single-row table metadata input.
- `overwrite`: Logical indicating whether to overwrite existing files.
- `min_file_size`: Minimum accepted payload size in bytes.

Returns: Tibble with one row containing processing status and metadata.

### `main.R`

#### `parse_command_line_args()`

Parse supported command line flags and update runtime configuration globals.

```r
parse_command_line_args <- function() {
```

Returns: `NULL`; updates global config variables by side effect.

#### `extract_arg_value()`

No roxygen summary available.

```r
extract_arg_value <- function(flag, default = NULL) {
```

#### `msg()`

Emit a formatted status message for CLI output.

```r
msg <- function(text, type = "info") {
```

Parameters:

- `text`: Message content.
- `type`: Message type key (`info`, `success`, `warn`, `error`, `progress`).

Returns: `NULL`.

#### `check_packages()`

Validate required package availability and optionally install missing ones.

```r
check_packages <- function(packages) {
```

Parameters:

- `packages`: Character vector of package names.

Returns: `NULL`; throws on unresolved package dependencies.

#### `setup_directories()`

Ensure output and log directories exist.

```r
setup_directories <- function() {
```

Returns: `NULL`.

#### `find_script_path()`

Resolve script path across common repository subdirectories.

```r
find_script_path <- function(script_name) {
```

Parameters:

- `script_name`: Script filename to resolve.

Returns: Character path to the first matching script candidate.

#### `main()`

Execute end-to-end digest scraping, link extraction, and download workflow.

```r
main <- function() {
```

Returns: `NULL`; emits status logs and writes output/log artifacts.

### `install_dependencies.R`

#### `msg()`

Emit a formatted setup message for CLI output.

```r
msg <- function(text, type = "info") {
```

Parameters:

- `text`: Message content.
- `type`: Message type (`info`, `success`, `warn`, `error`).

Returns: `NULL`.
